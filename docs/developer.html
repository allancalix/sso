<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Sam Ward" />
  <title>ark_auth: Developer Manual</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
body {
color: #111111;
}
h1,
h2,
h3,
h4,
h5,
h6 {
line-height: 1.25;
margin-top: 2em;
font-weight: normal;
}
h1 {
font-size: 3rem;
}
h2 {
font-size: 2.25rem;
}
h3 {
font-size: 1.5rem;
}
h4 {
font-size: 1.25rem;
}
h5 {
font-size: 1rem;
}
h6 {
font-size: 0.875rem;
}
p {
line-height: 1;
margin: 1em 0;
font-weight: normal;
}
pre,
code {
background-color: #f4f4f4;
}
</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">ark_auth: Developer Manual</h1>
<p class="author">Sam Ward</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#tools">Tools</a></li>
<li><a href="#manual">Manual</a></li>
<li><a href="#guide">Guide</a><ul>
<li><a href="#environment">Environment</a></li>
<li><a href="#database">Database</a></li>
<li><a href="#build">Build</a></li>
<li><a href="#test">Test</a></li>
</ul></li>
</ul>
</nav>
<h1 id="introduction">Introduction</h1>
<p>Manual for ark_auth developers.</p>
<h1 id="tools">Tools</h1>
<p>The ark_auth crate depends on <a href="https://www.postgresql.org/">PostgreSQL</a> and <a href="https://www.sqlite.org/index.html">SQLite</a> libraries, to install them on Debian Linux distributions.</p>
<pre class="shell"><code>sudo apt install libpq-dev libsqlite3-dev libssl-dev pkg-config</code></pre>
<p>Install <a href="https://www.rust-lang.org/">Rust</a> using <a href="https://rustup.rs/">rustup</a>. Check required components are installed..</p>
<pre class="shell"><code>rustup component add rustfmt
rustup component add clippy</code></pre>
<p>The ark_auth crate depends on <a href="cargo-make">Cargo Make</a> and <a href="diesel">Diesel</a>, install them with Cargo.</p>
<pre class="shell"><code>cargo install --force cargo-make
cargo install --force diesel_cli --no-default-features --features &quot;postgres sqlite&quot;</code></pre>
<p>To update the toolchain.</p>
<pre class="shell"><code>rustup self update
rustup update</code></pre>
<p>To update crate dependencies.</p>
<pre class="shell"><code>cargo update</code></pre>
<p><a href="https://docs.docker.com/install/">Docker</a> and <a href="https://docs.docker.com/compose/">Docker Compose</a> are used for development, install them using the linked documentation.</p>
<p>To start containers defined in <code>docker-compose.yml</code>.</p>
<pre class="shell"><code>docker-compose up</code></pre>
<p>To stop containers.</p>
<pre class="shell"><code>docker-compose down</code></pre>
<h1 id="manual">Manual</h1>
<p>This manual is written in <a href="https://pandoc.org/MANUAL.html#pandocs-markdown">Markdown</a> and converted into other formats using <a href="https://pandoc.org/">Pandoc</a>.</p>
<p>To build the HTML manual.</p>
<pre class="shell"><code>cargo make manual</code></pre>
<h1 id="guide">Guide</h1>
<h2 id="environment">Environment</h2>
<table>
<thead>
<tr class="header">
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>DATABASE_URL</td>
<td>Database connection URL, required.</td>
</tr>
<tr class="even">
<td>SERVER_BIND</td>
<td>Server bind address, required.</td>
</tr>
<tr class="odd">
<td>SMTP_HOST</td>
<td>SMTP configured, required for emails.</td>
</tr>
<tr class="even">
<td>SMTP_PORT</td>
<td>…</td>
</tr>
<tr class="odd">
<td>SMTP_USER</td>
<td>…</td>
</tr>
<tr class="even">
<td>SMTP_PASSWORD</td>
<td>…</td>
</tr>
<tr class="odd">
<td>SENTRY_URL</td>
<td>Sentry URL for logging integration, optional.</td>
</tr>
<tr class="even">
<td>GITHUB_CLIENT_ID</td>
<td>GitHub OAuth2 support, optional.</td>
</tr>
<tr class="odd">
<td>GITHUB_CLIENT_SECRET</td>
<td></td>
</tr>
<tr class="even">
<td>GITHUB_REDIRECT_URL</td>
<td><code>$server_url/v1/auth/provider/github/oauth2</code></td>
</tr>
<tr class="odd">
<td>MICROSOFT_CLIENT_ID</td>
<td>Microsoft OAuth2 support, optional.</td>
</tr>
<tr class="even">
<td>MICROSOFT_CLIENT_SECRET</td>
<td></td>
</tr>
<tr class="odd">
<td>MICROSOFT_REDIRECT_URL</td>
<td><code>$server_url/v1/auth/provider/microsoft/oauth2</code></td>
</tr>
</tbody>
</table>
<p><strong>Linux</strong></p>
<p>Write <code>export $NAME=&quot;$VALUE&quot;</code> statements to file <code>env.sh</code> and run <code>source env.sh</code> to export variables in open terminal.</p>
<h2 id="database">Database</h2>
<p>To create <a href="https://www.postgresql.org/">PostgreSQL</a> database migrations.</p>
<pre class="shell"><code>cargo make postgres-migrations</code></pre>
<p>To create <a href="https://www.sqlite.org/index.html">SQLite</a> database migrations.</p>
<pre class="shell"><code>cargo make sqlite-migrations</code></pre>
<h2 id="build">Build</h2>
<p>To build libraries and binaries.</p>
<pre class="shell"><code>cargo make build
cargo make release</code></pre>
<p>To lint source code using <a href="https://github.com/rust-lang/rust-clippy">clippy</a>.</p>
<pre class="shell"><code>cargo make lint</code></pre>
<p>To build documentation.</p>
<pre class="shell"><code>cargo doc --no-deps --open</code></pre>
<p>To build docker image.</p>
<pre class="shell"><code>cd ark_auth
docker-compose build</code></pre>
<h2 id="test">Test</h2>
<p>For integration tests, the following environment variables are required.</p>
<table>
<thead>
<tr class="header">
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>TEST_URL</td>
<td>Server URL.</td>
</tr>
<tr class="even">
<td>TEST_KEY</td>
<td>Root key value.</td>
</tr>
</tbody>
</table>
<p>To run unit and integration tests.</p>
<pre class="shell"><code>cargo make test</code></pre>
</body>
</html>
