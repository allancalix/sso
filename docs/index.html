<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Sam Ward" />
  <title>sso</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style>
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style type="text/css">
nav#TOC {
width: 240px;
position: absolute;
z-index: 1;
top: 240px;
left: 0;
background-color: #F4F4F4;
overflow-x: hidden;
}

html {
font-size: 100%;
overflow-y: scroll;
-webkit-text-size-adjust: 100%;
-ms-text-size-adjust: 100%;
}
body {
color: #444;
font-family: Georgia, Palatino, "Palatino Linotype", Times, "Times New Roman", serif;
font-size: 12px;
line-height: 1.7;
padding: 1em;
margin: auto;
max-width: 42em;
background: #fefefe;
}
a {
color: #0645ad;
text-decoration: none;
}
a:visited {
color: #0b0080;
}
a:hover {
color: #06e;
}
a:active {
color: #faa700;
}
a:focus {
outline: thin dotted;
}
*::-moz-selection {
background: rgba(255, 255, 0, 0.3);
color: #000;
}
*::selection {
background: rgba(255, 255, 0, 0.3);
color: #000;
}
a::-moz-selection {
background: rgba(255, 255, 0, 0.3);
color: #0645ad;
}
a::selection {
background: rgba(255, 255, 0, 0.3);
color: #0645ad;
}
p {
margin: 1em 0;
}
img {
max-width: 100%;
}
h1,
h2,
h3,
h4,
h5,
h6 {
color: #111;
line-height: 125%;
margin-top: 2em;
font-weight: normal;
}
h4,
h5,
h6 {
font-weight: bold;
}
h1 {
font-size: 2.5em;
}
h2 {
font-size: 2em;
}
h3 {
font-size: 1.5em;
}
h4 {
font-size: 1.2em;
}
h5 {
font-size: 1em;
}
h6 {
font-size: 0.9em;
}
blockquote {
color: #666666;
margin: 0;
padding-left: 3em;
border-left: 0.5em #eee solid;
}
hr {
display: block;
height: 2px;
border: 0;
border-top: 1px solid #aaa;
border-bottom: 1px solid #eee;
margin: 1em 0;
padding: 0;
}
pre,
code,
kbd,
samp {
color: #000;
font-family: monospace, monospace;
_font-family: "courier new", monospace;
font-size: 0.98em;
}
pre {
white-space: pre;
white-space: pre-wrap;
word-wrap: break-word;
}
b,
strong {
font-weight: bold;
}
dfn {
font-style: italic;
}
ins {
background: #ff9;
color: #000;
text-decoration: none;
}
mark {
background: #ff0;
color: #000;
font-style: italic;
font-weight: bold;
}
sub,
sup {
font-size: 75%;
line-height: 0;
position: relative;
vertical-align: baseline;
}
sup {
top: -0.5em;
}
sub {
bottom: -0.25em;
}
ul,
ol {
margin: 1em 0;
padding: 0 0 0 2em;
}
li p:last-child {
margin-bottom: 0;
}
ul ul,
ol ol {
margin: 0.3em 0;
}
dl {
margin-bottom: 1em;
}
dt {
font-weight: bold;
margin-bottom: 0.8em;
}
dd {
margin: 0 0 0.8em 2em;
}
dd:last-child {
margin-bottom: 0;
}
img {
border: 0;
-ms-interpolation-mode: bicubic;
vertical-align: middle;
}
figure {
display: block;
text-align: center;
margin: 1em 0;
}
figure img {
border: none;
margin: 0 auto;
}
figcaption {
font-size: 0.8em;
font-style: italic;
margin: 0 0 0.8em;
}
table {
margin-bottom: 2em;
border-bottom: 1px solid #ddd;
border-right: 1px solid #ddd;
border-spacing: 0;
border-collapse: collapse;
}
table th {
padding: 0.2em 1em;
background-color: #eee;
border-top: 1px solid #ddd;
border-left: 1px solid #ddd;
}
table td {
padding: 0.2em 1em;
border-top: 1px solid #ddd;
border-left: 1px solid #ddd;
vertical-align: top;
}
.author {
font-size: 1.2em;
text-align: center;
}
@media only screen and (min-width: 480px) {
body {
font-size: 14px;
}
}
@media only screen and (min-width: 768px) {
body {
font-size: 16px;
}
}
@media print {
* {
background: transparent !important;
color: black !important;
filter: none !important;
-ms-filter: none !important;
}
body {
font-size: 12pt;
max-width: 100%;
}
a,
a:visited {
text-decoration: underline;
}
hr {
height: 1px;
border: 0;
border-bottom: 1px solid black;
}
a[href]:after {
content: " (" attr(href) ")";
}
abbr[title]:after {
content: " (" attr(title) ")";
}
.ir a:after,
a[href^="javascript:"]:after,
a[href^="#"]:after {
content: "";
}
pre,
blockquote {
border: 1px solid #999;
padding-right: 1em;
page-break-inside: avoid;
}
tr,
img {
page-break-inside: avoid;
}
img {
max-width: 100% !important;
}
@page :left {
margin: 15mm 20mm 15mm 10mm;
}
@page :right {
margin: 15mm 10mm 15mm 20mm;
}
p,
h2,
h3 {
orphans: 3;
widows: 3;
}
h2,
h3 {
page-break-after: avoid;
}
}
</style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">sso</h1>
<p class="author">Sam Ward</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#manual">Manual</a><ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#definitions">Definitions</a></li>
</ul></li>
<li><a href="#guides">Guides</a><ul>
<li><a href="#quickstart">Quickstart</a></li>
<li><a href="#deployment">Deployment</a></li>
<li><a href="#integration">Integration</a></li>
<li><a href="#login">Login</a></li>
<li><a href="#reset-password">Reset Password</a></li>
<li><a href="#update-email">Update Email</a></li>
<li><a href="#update-password">Update Password</a></li>
<li><a href="#api-key">API Key</a></li>
<li><a href="#oauth2-login">OAuth2 Login</a></li>
<li><a href="#totp">TOTP</a></li>
<li><a href="#csrf">CSRF</a></li>
</ul></li>
<li><a href="#cli">CLI</a></li>
<li><a href="#changelog">Changelog</a><ul>
<li><a href="#section">0.7.0 (?)</a></li>
<li><a href="#section-1">0.6.0 (2019-10-07)</a></li>
<li><a href="#section-2">0.5.0 (2019-10-05)</a></li>
<li><a href="#section-3">0.4.0 (2019-09-09)</a></li>
<li><a href="#section-4">0.3.0 (2019-08-03)</a></li>
<li><a href="#section-5">0.2.0 (2019-07-07)</a></li>
<li><a href="#section-6">0.1.0 (2019-05-16)</a></li>
</ul></li>
<li><a href="#developer">Developer</a><ul>
<li><a href="#tools">Tools</a></li>
<li><a href="#manual-1">Manual</a></li>
<li><a href="#environment">Environment</a></li>
<li><a href="#database">Database</a></li>
<li><a href="#build">Build</a></li>
<li><a href="#test">Test</a></li>
</ul></li>
</ul>
</nav>
<h1 id="manual">Manual</h1>
<h2 id="introduction">Introduction</h2>
<p><strong>Warning: The author of this application is not a security expert, and the code has not undergone any kind of review or verification. Use it at your own risk!</strong></p>
<p>The crate <code>sso</code> is an authentication server binary. It is intended to be used as a backend for other services, such as API servers, which must authenticate user requests.</p>
<p>Authentication methods are organised into provider groups, The following provider groups are currently supported: <code>local</code>, <code>github</code>, <code>microsoft</code>. Depending on the provider, the following user authentication methods are supported.</p>
<h3 id="password-login-local">Password Login (local)</h3>
<ul>
<li>Users can authenticate to a service using a unique email address and password.</li>
<li>Successful login returns time-limited, revokable access and refresh <a href="jwt">JSON web tokens</a>.</li>
<li>Access tokens are used to authenticate user requests.</li>
<li>Refresh tokens are used to produce new access and refresh tokens.</li>
<li>User passwords can be reset via email, this feature can also be disabled for a user.</li>
<li>Users can be required to update their passwords.</li>
<li>User email address and password updates cause notification emails to be sent to the user.</li>
<li>Notification emails contain revokation links in case a login is compromised.</li>
<li>Passwords are stored as <a href="https://en.wikipedia.org/wiki/Argon2">argon2</a> hashes.</li>
<li>Password strength is checked by <a href="https://github.com/shssoichiro/zxcvbn-rs">zxcvbn</a>.</li>
<li>Password leaks are checked by <a href="pwned-passwords">Pwned Passwords</a>.</li>
<li>Users can be created without passwords to disable password login.</li>
</ul>
<h3 id="api-key-local">API Key (local)</h3>
<ul>
<li>Users can authenticate requests to a service using a unique, random key.</li>
<li>Keys are not time-limited, but are revokable.</li>
</ul>
<h3 id="totp-local">TOTP (local)</h3>
<ul>
<li>Services can authenticate user requests that contain a <a href="totp">TOTP</a> code.</li>
</ul>
<h3 id="oauth2-github-microsoft">OAuth2 (github, microsoft)</h3>
<ul>
<li>Users can authenticate to a service via supported OAuth2 providers.</li>
<li>Successful login returns time-limited, revokable access and refresh <a href="jwt">JSON web tokens</a>.</li>
<li>Access tokens are used to authenticate user requests.</li>
<li>Refresh tokens are used to produce new access and refresh tokens.</li>
</ul>
<h2 id="definitions">Definitions</h2>
<p>The following terms are used throughout this manual.</p>
<h3 id="service">Service</h3>
<p>An application that must authenticate user requests, registered as a service with <code>sso</code> using a name and callback URLs for supported authentication providers.</p>
<h3 id="user">User</h3>
<p>A person or other external API consumer identified by a unique email address who wants to interact with one or more services registered with <code>sso</code>.</p>
<h3 id="key">Key</h3>
<p>Random, unique keys produced by <code>sso</code> with a specified type (<code>Key</code>, <code>Token</code> or <code>Totp</code>). Keys may be revoked to prevent use.</p>
<h3 id="root-key">Root Key</h3>
<p>Keys linked to no services or users, produced by command line and can be used to manage <code>sso</code> via HTTP requests. <code>Key</code> type.</p>
<h3 id="service-key">Service Key</h3>
<p>Keys linked to one service, used by <code>sso</code> to authenticate HTTP requests from services. <code>Key</code> type.</p>
<h3 id="user-key">User Key</h3>
<p>Keys linked to one user and one service, allows user to authenticate with the linked service. Any type, type determines what the key may be used for (e.g. <code>Token</code> keys are used for email and password login).</p>
<h3 id="token">Token</h3>
<p><a href="jwt">JSON web tokens</a> used for time-limited authentication, produced for users from a user key. Revoking the key used to produce a token also revokes the token. Tokens have a type which determines what the token may be used for (e.g. single use reset password token).</p>
<h1 id="guides">Guides</h1>
<h2 id="quickstart">Quickstart</h2>
<p>TODO(docs): Write quickstart guide.</p>
<h2 id="deployment">Deployment</h2>
<p>TODO(docs): How to deploy sso server. TODO(docs): Postgres encryption.</p>
<p><strong>Nginx</strong></p>
<p>Example <a href="https://www.nginx.com/">nginx</a> configuration.</p>
<pre class="nginx"><code>http {
    # HTTPS and headers configuration.
    # https://www.nginx.com/blog/using-free-ssltls-certificates-from-lets-encrypt-with-nginx/
    # https://www.owasp.org/index.php/OWASP_Secure_Headers_Project

    # API request rate limit.
    # https://www.nginx.com/blog/rate-limiting-nginx/
    limit_req_zone $binary_remote_addr zone=api_zone:10m rate=50r/s;

    # API proxy server.
    # https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/
    location /api {
        limit_req zone=api_zone burst=100 nodelay;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass http://127.0.0.1:4000;
    }
}</code></pre>
<p><strong>Prometheus</strong></p>
<p>Example <a href="https://prometheus.io/">Prometheus</a> configuration.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">scrape_configs</span><span class="kw">:</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">    # ...</span></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">job_name</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;sso&quot;</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="at">      </span><span class="fu">metrics_path</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;/v1/metrics&quot;</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="at">      </span><span class="fu">bearer_token</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;$root_or_service_key&quot;</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="at">      </span><span class="fu">static_configs</span><span class="kw">:</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="at">          </span><span class="kw">-</span><span class="at"> </span><span class="fu">targets</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;$server_url&quot;</span><span class="kw">]</span></span></code></pre></div>
<pre class="shell"><code>curl --header &quot;Authorization: $root_or_service_key&quot; $server_url/v1/metrics</code></pre>
<h2 id="integration">Integration</h2>
<p>The following diagram illustrates how services and sso integrate to authenticate user requests.</p>
<figure>
<img src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiIHN0YW5kYWxvbmU9Im5vIj8+PCFET0NUWVBFIHN2ZyBQVUJMSUMgIi0vL1czQy8vRFREIFNWRyAyMDAxMDkwNC8vRU4iICJodHRwOi8vd3d3LnczLm9yZy9UUi8yMDAxL1JFQy1TVkctMjAwMTA5MDQvRFREL3N2ZzEwLmR0ZCI+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MzIiIGhlaWdodD0iNTMzIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+PHNvdXJjZT48IVtDREFUQVtOb3RlIG92ZXIgVXNlcjogMS4gVXNlciBUb2tlbiBvciBLZXkKVXNlci0+PlNlcnZpY2U6IEhUVFAgUmVxdWVzdApOb3RlIG92ZXIgU2VydmljZTogMi4gU2VydmljZSBLZXkKU2VydmljZS0+PnNzbzogSFRUUCBSZXF1ZXN0Ck5vdGUgb3ZlciBzc286IDMuIFZlcmlmeQpzc28tPj5TZXJ2aWNlOiBIVFRQIFJlc3BvbnNlCk5vdGUgb3ZlciBTZXJ2aWNlOiA0LiBSZXF1ZXN0IEhhbmRsZXIKU2VydmljZS0+PlVzZXI6IEhUVFAgUmVzcG9uc2UKTm90ZSBvdmVyIFVzZXI6IDUuIFJlc3BvbnNlIEhhbmRsZXJdXT48L3NvdXJjZT48ZGVzYz48L2Rlc2M+PGRlZnM+PG1hcmtlciB2aWV3Qm94PSIwIDAgNSA1IiBtYXJrZXJXaWR0aD0iNSIgbWFya2VySGVpZ2h0PSI1IiBvcmllbnQ9ImF1dG8iIHJlZlg9IjUiIHJlZlk9IjIuNSIgaWQ9Im1hcmtlckFycm93QmxvY2siPjxwYXRoIGQ9Ik0gMCAwIEwgNSAyLjUgTCAwIDUgeiI+PC9wYXRoPjwvbWFya2VyPjxtYXJrZXIgdmlld0JveD0iMCAwIDkuNiAxNiIgbWFya2VyV2lkdGg9IjQiIG1hcmtlckhlaWdodD0iMTYiIG9yaWVudD0iYXV0byIgcmVmWD0iOS42IiByZWZZPSI4IiBpZD0ibWFya2VyQXJyb3dPcGVuIj48cGF0aCBkPSJNIDkuNiw4IDEuOTIsMTYgMCwxMy43IDUuNzYsOCAwLDIuMjg2IDEuOTIsMCA5LjYsOCB6Ij48L3BhdGg+PC9tYXJrZXI+PC9kZWZzPjxnIGNsYXNzPSJ0aXRsZSI+PC9nPjxnIGNsYXNzPSJhY3RvciI+PHJlY3QgeD0iODEiIHk9IjIwIiB3aWR0aD0iNTgiIGhlaWdodD0iMzguNSIgc3R5bGU9InN0cm9rZS13aWR0aDogMjsiIHN0cm9rZT0iIzAwMDAwMCIgZmlsbD0iI2ZmZmZmZiI+PC9yZWN0Pjx0ZXh0IHg9IjkxIiB5PSI0NSIgc3R5bGU9ImZvbnQtc2l6ZTogMTZweDsgZm9udC1mYW1pbHk6IEFuZGFsZSBNb25vLCBtb25vc3BhY2U7Ij48dHNwYW4geD0iOTEiPlVzZXI8L3RzcGFuPjwvdGV4dD48L2c+PGcgY2xhc3M9ImFjdG9yIj48cmVjdCB4PSI4MSIgeT0iNDc1IiB3aWR0aD0iNTgiIGhlaWdodD0iMzguNSIgc3R5bGU9InN0cm9rZS13aWR0aDogMjsiIHN0cm9rZT0iIzAwMDAwMCIgZmlsbD0iI2ZmZmZmZiI+PC9yZWN0Pjx0ZXh0IHg9IjkxIiB5PSI1MDAiIHN0eWxlPSJmb250LXNpemU6IDE2cHg7IGZvbnQtZmFtaWx5OiBBbmRhbGUgTW9ubywgbW9ub3NwYWNlOyI+PHRzcGFuIHg9IjkxIj5Vc2VyPC90c3Bhbj48L3RleHQ+PC9nPjxsaW5lIHgxPSIxMTAiIHgyPSIxMTAiIHkxPSI1OC41IiB5Mj0iNDc1IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOiAyOyIgc3Ryb2tlPSIjMDAwMDAwIiBmaWxsPSJub25lIj48L2xpbmU+PGcgY2xhc3M9ImFjdG9yIj48cmVjdCB4PSIyMTAuMjUiIHk9IjIwIiB3aWR0aD0iODYuNSIgaGVpZ2h0PSIzOC41IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOiAyOyIgc3Ryb2tlPSIjMDAwMDAwIiBmaWxsPSIjZmZmZmZmIj48L3JlY3Q+PHRleHQgeD0iMjIwLjI1IiB5PSI0NSIgc3R5bGU9ImZvbnQtc2l6ZTogMTZweDsgZm9udC1mYW1pbHk6IEFuZGFsZSBNb25vLCBtb25vc3BhY2U7Ij48dHNwYW4geD0iMjIwLjI1Ij5TZXJ2aWNlPC90c3Bhbj48L3RleHQ+PC9nPjxnIGNsYXNzPSJhY3RvciI+PHJlY3QgeD0iMjEwLjI1IiB5PSI0NzUiIHdpZHRoPSI4Ni41IiBoZWlnaHQ9IjM4LjUiIHN0eWxlPSJzdHJva2Utd2lkdGg6IDI7IiBzdHJva2U9IiMwMDAwMDAiIGZpbGw9IiNmZmZmZmYiPjwvcmVjdD48dGV4dCB4PSIyMjAuMjUiIHk9IjUwMCIgc3R5bGU9ImZvbnQtc2l6ZTogMTZweDsgZm9udC1mYW1pbHk6IEFuZGFsZSBNb25vLCBtb25vc3BhY2U7Ij48dHNwYW4geD0iMjIwLjI1Ij5TZXJ2aWNlPC90c3Bhbj48L3RleHQ+PC9nPjxsaW5lIHgxPSIyNTMuNSIgeDI9IjI1My41IiB5MT0iNTguNSIgeTI9IjQ3NSIgc3R5bGU9InN0cm9rZS13aWR0aDogMjsiIHN0cm9rZT0iIzAwMDAwMCIgZmlsbD0ibm9uZSI+PC9saW5lPjxnIGNsYXNzPSJhY3RvciI+PHJlY3QgeD0iMzQ5IiB5PSIyMCIgd2lkdGg9Ijk2IiBoZWlnaHQ9IjM4LjUiIHN0eWxlPSJzdHJva2Utd2lkdGg6IDI7IiBzdHJva2U9IiMwMDAwMDAiIGZpbGw9IiNmZmZmZmYiPjwvcmVjdD48dGV4dCB4PSIzNTkiIHk9IjQ1IiBzdHlsZT0iZm9udC1zaXplOiAxNnB4OyBmb250LWZhbWlseTogQW5kYWxlIE1vbm8sIG1vbm9zcGFjZTsiPjx0c3BhbiB4PSIzNTkiPnNzbzwvdHNwYW4+PC90ZXh0PjwvZz48ZyBjbGFzcz0iYWN0b3IiPjxyZWN0IHg9IjM0OSIgeT0iNDc1IiB3aWR0aD0iOTYiIGhlaWdodD0iMzguNSIgc3R5bGU9InN0cm9rZS13aWR0aDogMjsiIHN0cm9rZT0iIzAwMDAwMCIgZmlsbD0iI2ZmZmZmZiI+PC9yZWN0Pjx0ZXh0IHg9IjM1OSIgeT0iNTAwIiBzdHlsZT0iZm9udC1zaXplOiAxNnB4OyBmb250LWZhbWlseTogQW5kYWxlIE1vbm8sIG1vbm9zcGFjZTsiPjx0c3BhbiB4PSIzNTkiPnNzbzwvdHNwYW4+PC90ZXh0PjwvZz48bGluZSB4MT0iMzk3IiB4Mj0iMzk3IiB5MT0iNTguNSIgeTI9IjQ3NSIgc3R5bGU9InN0cm9rZS13aWR0aDogMjsiIHN0cm9rZT0iIzAwMDAwMCIgZmlsbD0ibm9uZSI+PC9saW5lPjxnIGNsYXNzPSJub3RlIj48cmVjdCB4PSIxMCIgeT0iNzguNSIgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyOC41IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOiAyOyIgc3Ryb2tlPSIjMDAwMDAwIiBmaWxsPSIjZmZmZmZmIj48L3JlY3Q+PHRleHQgeD0iMTUiIHk9Ijk4LjUiIHN0eWxlPSJmb250LXNpemU6IDE2cHg7IGZvbnQtZmFtaWx5OiBBbmRhbGUgTW9ubywgbW9ub3NwYWNlOyI+PHRzcGFuIHg9IjE1Ij4xLiBVc2VyIFRva2VuIG9yIEtleTwvdHNwYW4+PC90ZXh0PjwvZz48ZyBjbGFzcz0ic2lnbmFsIj48dGV4dCB4PSIxMjQuNzUiIHk9IjEzNy43NSIgc3R5bGU9ImZvbnQtc2l6ZTogMTZweDsgZm9udC1mYW1pbHk6IEFuZGFsZSBNb25vLCBtb25vc3BhY2U7Ij48dHNwYW4geD0iMTI0Ljc1Ij5IVFRQIFJlcXVlc3Q8L3RzcGFuPjwvdGV4dD48bGluZSB4MT0iMTEwIiB4Mj0iMjUzLjUiIHkxPSIxNDUuNSIgeTI9IjE0NS41IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOiAyOyBtYXJrZXItZW5kOiB1cmwoJnF1b3Q7I21hcmtlckFycm93T3BlbiZxdW90Oyk7IiBzdHJva2U9IiMwMDAwMDAiIGZpbGw9Im5vbmUiPjwvbGluZT48L2c+PGcgY2xhc3M9Im5vdGUiPjxyZWN0IHg9IjE4MiIgeT0iMTY1LjUiIHdpZHRoPSIxNDMiIGhlaWdodD0iMjguNSIgc3R5bGU9InN0cm9rZS13aWR0aDogMjsiIHN0cm9rZT0iIzAwMDAwMCIgZmlsbD0iI2ZmZmZmZiI+PC9yZWN0Pjx0ZXh0IHg9IjE4NyIgeT0iMTg1LjUiIHN0eWxlPSJmb250LXNpemU6IDE2cHg7IGZvbnQtZmFtaWx5OiBBbmRhbGUgTW9ubywgbW9ub3NwYWNlOyI+PHRzcGFuIHg9IjE4NyI+Mi4gU2VydmljZSBLZXk8L3RzcGFuPjwvdGV4dD48L2c+PGcgY2xhc3M9InNpZ25hbCI+PHRleHQgeD0iMjY4LjI1IiB5PSIyMjQuNzUiIHN0eWxlPSJmb250LXNpemU6IDE2cHg7IGZvbnQtZmFtaWx5OiBBbmRhbGUgTW9ubywgbW9ub3NwYWNlOyI+PHRzcGFuIHg9IjI2OC4yNSI+SFRUUCBSZXF1ZXN0PC90c3Bhbj48L3RleHQ+PGxpbmUgeDE9IjI1My41IiB4Mj0iMzk3IiB5MT0iMjMyLjUiIHkyPSIyMzIuNSIgc3R5bGU9InN0cm9rZS13aWR0aDogMjsgbWFya2VyLWVuZDogdXJsKCZxdW90OyNtYXJrZXJBcnJvd09wZW4mcXVvdDspOyIgc3Ryb2tlPSIjMDAwMDAwIiBmaWxsPSJub25lIj48L2xpbmU+PC9nPjxnIGNsYXNzPSJub3RlIj48cmVjdCB4PSIzNDkuMjUiIHk9IjI1Mi41IiB3aWR0aD0iOTUuNSIgaGVpZ2h0PSIyOC41IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOiAyOyIgc3Ryb2tlPSIjMDAwMDAwIiBmaWxsPSIjZmZmZmZmIj48L3JlY3Q+PHRleHQgeD0iMzU0LjI1IiB5PSIyNzIuNSIgc3R5bGU9ImZvbnQtc2l6ZTogMTZweDsgZm9udC1mYW1pbHk6IEFuZGFsZSBNb25vLCBtb25vc3BhY2U7Ij48dHNwYW4geD0iMzU0LjI1Ij4zLiBWZXJpZnk8L3RzcGFuPjwvdGV4dD48L2c+PGcgY2xhc3M9InNpZ25hbCI+PHRleHQgeD0iMjYzLjUiIHk9IjMxMS43NSIgc3R5bGU9ImZvbnQtc2l6ZTogMTZweDsgZm9udC1mYW1pbHk6IEFuZGFsZSBNb25vLCBtb25vc3BhY2U7Ij48dHNwYW4geD0iMjYzLjUiPkhUVFAgUmVzcG9uc2U8L3RzcGFuPjwvdGV4dD48bGluZSB4MT0iMzk3IiB4Mj0iMjUzLjUiIHkxPSIzMTkuNSIgeTI9IjMxOS41IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOiAyOyBtYXJrZXItZW5kOiB1cmwoJnF1b3Q7I21hcmtlckFycm93T3BlbiZxdW90Oyk7IiBzdHJva2U9IiMwMDAwMDAiIGZpbGw9Im5vbmUiPjwvbGluZT48L2c+PGcgY2xhc3M9Im5vdGUiPjxyZWN0IHg9IjE2MyIgeT0iMzM5LjUiIHdpZHRoPSIxODEiIGhlaWdodD0iMjguNSIgc3R5bGU9InN0cm9rZS13aWR0aDogMjsiIHN0cm9rZT0iIzAwMDAwMCIgZmlsbD0iI2ZmZmZmZiI+PC9yZWN0Pjx0ZXh0IHg9IjE2OCIgeT0iMzU5LjUiIHN0eWxlPSJmb250LXNpemU6IDE2cHg7IGZvbnQtZmFtaWx5OiBBbmRhbGUgTW9ubywgbW9ub3NwYWNlOyI+PHRzcGFuIHg9IjE2OCI+NC4gUmVxdWVzdCBIYW5kbGVyPC90c3Bhbj48L3RleHQ+PC9nPjxnIGNsYXNzPSJzaWduYWwiPjx0ZXh0IHg9IjEyMCIgeT0iMzk4Ljc1IiBzdHlsZT0iZm9udC1zaXplOiAxNnB4OyBmb250LWZhbWlseTogQW5kYWxlIE1vbm8sIG1vbm9zcGFjZTsiPjx0c3BhbiB4PSIxMjAiPkhUVFAgUmVzcG9uc2U8L3RzcGFuPjwvdGV4dD48bGluZSB4MT0iMjUzLjUiIHgyPSIxMTAiIHkxPSI0MDYuNSIgeTI9IjQwNi41IiBzdHlsZT0ic3Ryb2tlLXdpZHRoOiAyOyBtYXJrZXItZW5kOiB1cmwoJnF1b3Q7I21hcmtlckFycm93T3BlbiZxdW90Oyk7IiBzdHJva2U9IiMwMDAwMDAiIGZpbGw9Im5vbmUiPjwvbGluZT48L2c+PGcgY2xhc3M9Im5vdGUiPjxyZWN0IHg9IjE0Ljc1IiB5PSI0MjYuNSIgd2lkdGg9IjE5MC41IiBoZWlnaHQ9IjI4LjUiIHN0eWxlPSJzdHJva2Utd2lkdGg6IDI7IiBzdHJva2U9IiMwMDAwMDAiIGZpbGw9IiNmZmZmZmYiPjwvcmVjdD48dGV4dCB4PSIxOS43NSIgeT0iNDQ2LjUiIHN0eWxlPSJmb250LXNpemU6IDE2cHg7IGZvbnQtZmFtaWx5OiBBbmRhbGUgTW9ubywgbW9ub3NwYWNlOyI+PHRzcGFuIHg9IjE5Ljc1Ij41LiBSZXNwb25zZSBIYW5kbGVyPC90c3Bhbj48L3RleHQ+PC9nPjwvc3ZnPgo=" alt /><figcaption>User request verification</figcaption>
</figure>
<ol type="1">
<li>User with token or key acquired by authentication method sends HTTP request to service.</li>
<li>Service sends HTTP request to sso with its own service key, and the users token or key.</li>
<li>sso authenticates service using the service key, and verifies user token or key.</li>
<li>If authenticated/verified, service handles request and sends HTTP response to user.</li>
<li>User handles HTTP response.</li>
</ol>
<p><strong>Callbacks</strong></p>
<p>A service integrating with sso can provide the following HTTPS endpoints as callbacks.</p>
<pre class="shell"><code>GET $service_url?type=oauth2&amp;user_id=$id&amp;access_token=$token&amp;access_token_expires=$token_expires&amp;refresh_token=$token&amp;refresh_token_expires=$token_expires</code></pre>
<p>User is redirected to this URL after successful authentication by an OAuth2 provider. The service can verify the <code>access_token</code> query parameter to authenticate the user and their requests.</p>
<pre class="shell"><code>GET $service_url?type=reset_password&amp;email=$email&amp;token=$token</code></pre>
<p>User requests this URL by clicking reset password email link. The service can take password input from the user, and then make a reset password confirm request with the <code>token</code> query parameter.</p>
<pre class="shell"><code>GET $service_url?type=update_email&amp;email=$email&amp;old_email=$email&amp;token=$token</code></pre>
<p>User requests this URL by clicking update email revoke link. The service can present the user information on securing their account, and then make an update email revoke request with the <code>token</code> query parameter. This will disable the user and all user keys.</p>
<pre class="shell"><code>GET $service_url?type=update_password&amp;email=$email&amp;token=$token</code></pre>
<p>User requests this URL by clicking update password revoke link. The service can present the user information on securing their account, and then make an update password revoke request with the <code>token</code> query parameter. This will disable the user and all user keys.</p>
<h2 id="login">Login</h2>
<p>Create service with key and start server.</p>
<pre class="shell"><code>sso create-service-with-key $service_name $service_url
sso start-server</code></pre>
<p>Service creates a user with password.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;name&quot;:&quot;$user_name&quot;,&quot;email&quot;:&quot;$user_email&quot;,&quot;password&quot;:&quot;$user_password&quot;}&#39; \
  $server_url/v1/user</code></pre>
<p>Service creates a key for user.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;name&quot;:&quot;$key_name&quot;,&quot;user_id&quot;:&quot;$user_id&quot;}&#39; \
  $server_url/v1/key</code></pre>
<p>User makes login request to service, services makes a login request.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;email&quot;:&quot;$user_email&quot;,&quot;password&quot;:&quot;$user_password&quot;}&#39; \
  $server_url/v1/auth/provider/local/login</code></pre>
<p>Service receives token response, access token can be verified to authenticate requests.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;token&quot;:&quot;$access_token&quot;}&#39; \
  $server_url/v1/auth/token/verify</code></pre>
<p>Refresh token can be used to refresh token.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;token&quot;:&quot;$refresh_token&quot;}&#39; \
  $server_url/v1/auth/token/refresh</code></pre>
<p>Access or refresh token can be revoked, this will disable the key created earlier and prevent verify and refresh.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;token&quot;:&quot;$token&quot;}&#39; \
  $server_url/v1/auth/token/revoke</code></pre>
<h2 id="reset-password">Reset Password</h2>
<p>Create service with key and start server.</p>
<pre class="shell"><code>sso create-service-with-key $service_name $service_url
sso start-server</code></pre>
<p>Service creates a user with password.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;name&quot;:&quot;$user_name&quot;,&quot;email&quot;:&quot;$user_email&quot;,&quot;password&quot;:&quot;$user_password&quot;}&#39; \
  $server_url/v1/user</code></pre>
<p>Service creates a key for user.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;name&quot;:&quot;$key_name&quot;,&quot;user_id&quot;:&quot;$user_id&quot;}&#39; \
  $server_url/v1/key</code></pre>
<p>User makes reset password request to service, service makes a reset password request.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;email&quot;:&quot;$user_email&quot;}&#39; \
  $server_url/v1/auth/provider/local/reset-password</code></pre>
<p>Email containing URL is sent to user email address, URL in format <code>$service_url?email=$user_email&amp;reset_password_token=$token</code>.</p>
<p>Service receives token via query parameter and makes reset password confirm request.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;token&quot;:&quot;$token&quot;,&quot;password&quot;:&quot;$user_password&quot;}&#39; \
  $server_url/v1/auth/provider/local/reset-password/confirm</code></pre>
<p>User makes login request to service, service makes a login request.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;email&quot;:&quot;$user_email&quot;,&quot;password&quot;:&quot;$user_password&quot;}&#39; \
  $server_url/v1/auth/provider/local/login</code></pre>
<h2 id="update-email">Update Email</h2>
<p>Create service with key and start server.</p>
<pre class="shell"><code>sso create-service-with-key $service_name $service_url
sso start-server</code></pre>
<p>Service creates a user with password.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;name&quot;:&quot;$user_name&quot;,&quot;email&quot;:&quot;$user_email&quot;,&quot;password&quot;:&quot;$user_password&quot;}&#39; \
  $server_url/v1/user</code></pre>
<p>Service creates a key for user.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;name&quot;:&quot;$key_name&quot;,&quot;user_id&quot;:&quot;$user_id&quot;}&#39; \
  $server_url/v1/key</code></pre>
<p>User makes update email request to service, service makes an update email request.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;key&quot;:&quot;$user_key&quot;,&quot;password&quot;:&quot;$user_password&quot;,&quot;new_email&quot;:&quot;$new_user_email&quot;}&#39; \
  $server_url/v1/auth/provider/local/update-email</code></pre>
<p>User makes login request to service, service makes a login request.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;email&quot;:&quot;$new_user_email&quot;,&quot;password&quot;:&quot;$user_password&quot;}&#39; \
  $server_url/v1/auth/provider/local/login</code></pre>
<p>After successful update, an email containing URL is sent to the old user email address, URL in format: <code>$service_url?email=$email&amp;update_email_token=$token</code>.</p>
<p>If user opens URL, service receives token via query parameter and makes update email revoke request, this will disable user and all linked keys and prevent login.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;token&quot;:&quot;$token&quot;}&#39; \
  $server_url/v1/auth/provider/local/update-email/revoke</code></pre>
<h2 id="update-password">Update Password</h2>
<p>Create service with key and start server.</p>
<pre class="shell"><code>sso create-service-with-key $service_name $service_url
sso start-server</code></pre>
<p>Service creates a user with password.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;name&quot;:&quot;$user_name&quot;,&quot;email&quot;:&quot;$user_email&quot;,&quot;password&quot;:&quot;$user_password&quot;}&#39; \
  $server_url/v1/user</code></pre>
<p>Service creates a key for user.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;name&quot;:&quot;$key_name&quot;,&quot;user_id&quot;:&quot;$user_id&quot;}&#39; \
  $server_url/v1/key</code></pre>
<p>User makes update password request to service, service makes an update password request.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;key&quot;:&quot;$user_key&quot;,&quot;password&quot;:&quot;$user_password&quot;,&quot;new_password&quot;:&quot;$new_user_password&quot;}&#39; \
  $server_url/v1/auth/provider/local/update-password</code></pre>
<p>User makes login request to service, service makes a login request.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;email&quot;:&quot;$user_email&quot;,&quot;password&quot;:&quot;$new_user_password&quot;}&#39; \
  $server_url/v1/auth/provider/local/login</code></pre>
<p>After successful update, an email containing URL is sent to user email address, URL in format: <code>$service_url?email=$email&amp;update_password_token=$token</code>.</p>
<p>If user opens URL, service receives token via query parameter and makes update password revoke request, this will disable user and all linked keys and prevent login.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;token&quot;:&quot;$token&quot;}&#39; \
  $server_url/v1/auth/provider/local/update-password/revoke</code></pre>
<h2 id="api-key">API Key</h2>
<p>Create service with key and start server.</p>
<pre class="shell"><code>sso create-service-with-key $service_name $service_url \
    [--local-url $service_local_url]
sso start-server</code></pre>
<p>Service creates a user without password.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;name&quot;:&quot;$user_name&quot;,&quot;email&quot;:&quot;$user_email&quot;}&#39; \
  $server_url/v1/user</code></pre>
<p>Service creates a key for user.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;name&quot;:&quot;$key_name&quot;,&quot;user_id&quot;:&quot;$user_id&quot;}&#39; \
  $server_url/v1/key</code></pre>
<p>User makes requests to service with key value, key can be verified to authenticate requests.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;key&quot;:&quot;$user_key&quot;}&#39; \
  $server_url/v1/auth/key/verify</code></pre>
<p>Key can be revoked, this will disable the key created earlier and prevent verify.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;key&quot;:&quot;$user_key&quot;}&#39; \
  $server_url/v1/auth/key/revoke</code></pre>
<h2 id="oauth2-login">OAuth2 Login</h2>
<p><code>$server_url/v1/auth/provider/github/oauth2</code></p>
<p>Create service with OAuth2 provider URL and key, and start server.</p>
<pre class="shell"><code>sso create-service-with-key $service_name $service_url \
    [--github-oauth2-url $service_github_oauth2_url] \
    [--microsoft-oauth2-url $service_microsoft_oauth2_url]
sso start-server</code></pre>
<p>Service creates a user with email address matching OAuth2 provider.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;name&quot;:&quot;$user_name&quot;,&quot;email&quot;:&quot;$user_email&quot;}&#39; \
  $server_url/v1/user</code></pre>
<p>Service creates a key for user.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;name&quot;:&quot;$key_name&quot;,&quot;user_id&quot;:&quot;$user_id&quot;}&#39; \
  $server_url/v1/key</code></pre>
<p>User makes OAuth2 login request to service.</p>
<p>Service requests a redirect URL for OAuth2 provider, supported providers are <code>github</code>, <code>microsoft</code>.</p>
<pre class="shell"><code>curl --header &quot;Authorization: $service_key&quot; \
  --request POST \
  $server_url/v1/auth/provider/$oauth2_provider/oauth2</code></pre>
<p>Service redirects user to returned URL, OAuth2 provider authentication occurs.</p>
<p>If successful, OAuth2 provider redirects user to <code>$server_url/v1/auth/provider/$oauth2_provider/oauth2</code> with required query parameters.</p>
<p>Query parameters are exchanged for API access token, authenticated email address is requested from OAuth2 provider APIs.</p>
<p>If authenticated email returned by API matches a user email address, and user has key for specified service, a user token is produced and the user is redirected to <code>$service_url?access_token=$token&amp;refresh_token=$token</code>.</p>
<p>Service receives access token and refresh token via query parameters. Service can verify access token to authenticate requests.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;token&quot;:&quot;$access_token&quot;}&#39; \
  $server_url/v1/auth/token/verify</code></pre>
<p>Refresh token can be used to refresh token.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;token&quot;:&quot;$refresh_token&quot;}&#39; \
  $server_url/v1/auth/token/refresh</code></pre>
<p>Access or refresh token can be revoked, this will disable the key created earlier and prevent verify and refresh.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;token&quot;:&quot;$token&quot;}&#39; \
  $server_url/v1/auth/token/revoke</code></pre>
<h2 id="totp">TOTP</h2>
<p>Create service with key and start server.</p>
<pre class="shell"><code>sso create-service-with-key $service_name $service_url
sso start-server</code></pre>
<p>Service creates a user (password optional).</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;name&quot;:&quot;$user_name&quot;,&quot;email&quot;:&quot;$user_email&quot;,&quot;locale&quot;:&quot;$user_locale&quot;,&quot;timezone&quot;:&quot;$user_timezone&quot;}&#39; \
  $server_url/v1/user</code></pre>
<p>Service creates a TOTP key for user.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;is_enabled&quot;:true,&quot;allow_key&quot;:false,&quot;allow_token&quot;:false,&quot;allow_totp&quot;:true,&quot;name&quot;:&quot;$key_name&quot;,&quot;user_id&quot;:&quot;$user_id&quot;}&#39; \
  $server_url/v1/key</code></pre>
<p>Generate QR code using the tool: <a href="https://freeotp.github.io/qrcode.html" class="uri">https://freeotp.github.io/qrcode.html</a></p>
<ul>
<li>Issuer: sso</li>
<li>Account: $user_email</li>
<li>Secret: $user_key_value</li>
<li>Digits: 6</li>
<li>SHA1</li>
<li>Timeout</li>
<li>30s</li>
</ul>
<p>Import the QR code into the application: <a href="https://freeotp.github.io/" class="uri">https://freeotp.github.io/</a></p>
<p>User makes request to service with TOTP code, service verifies TOTP code.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;user_id&quot;:&quot;$user_id&quot;,&quot;totp&quot;:&quot;$totp_code&quot;}&#39; \
  $server_url/v1/auth/totp</code></pre>
<p>Key can be revoked, this will disable the key created earlier and prevent TOTP verification.</p>
<pre class="shell"><code>curl --header &quot;Content-Type: application/json&quot; \
  --header &quot;Authorization: $service_key&quot; \
  --request POST \
  --data &#39;{&quot;key&quot;:&quot;$user_key&quot;}&#39; \
  $server_url/v1/auth/key/revoke</code></pre>
<h2 id="csrf">CSRF</h2>
<p>TODO(docs): Write CSRF guide.</p>
<h1 id="cli">CLI</h1>
<p>TODO(docs): CLI documentation.</p>
<h1 id="changelog">Changelog</h1>
<h2 id="section">0.7.0 (?)</h2>
<h3 id="added">Added</h3>
<ul>
<li>Added <code>Debug</code> trait implementations for public types.</li>
<li>Added filters to key list endpoint with <code>KeyFilter</code> options.</li>
<li>Added filters to service list endpoint with <code>ServiceFilter</code> options.</li>
<li>Added <code>id</code> query parameter array for key, service and user list endpoint filtering.</li>
<li>Added <code>docker-pg-dump</code>, <code>docker-pg-restore</code> targets to <code>Makefile.toml</code>.</li>
<li>Added CSRF create and verify API endpoints.</li>
</ul>
<h3 id="changed">Changed</h3>
<ul>
<li>Changed table column names to remove prefixes for <code>DriverPostgres</code>.</li>
<li>Key value is only returned via created endpoint.</li>
</ul>
<h3 id="fixed">Fixed</h3>
<ul>
<li>Fixed <code>clippy</code> too many arguments warnings.</li>
<li>Fixed <code>ClientActor</code> GET request ignores query string.</li>
<li>Fixed 500 status code returned trying to create key with invalid service or user ID.</li>
</ul>
<h2 id="section-1">0.6.0 (2019-10-07)</h2>
<h3 id="changed-1">Changed</h3>
<ul>
<li>Replaced key flags with type: <code>Key</code>, <code>Token</code> or <code>Totp</code>.</li>
<li>Added user flags: <code>password_allow_reset</code> and <code>password_require_update</code>.</li>
<li>Return <code>Unauthorised</code> instead of <code>Forbidden</code> for missing authentication.</li>
<li>User update email and password endpoints accept <code>user_id</code> instead of <code>key</code> or <code>token</code>.</li>
</ul>
<h3 id="fixed-1">Fixed</h3>
<ul>
<li>Fixed read user by ID route <code>/v1/user/{id}</code> attempts to read key.</li>
</ul>
<h2 id="section-2">0.5.0 (2019-10-05)</h2>
<h3 id="added-1">Added</h3>
<ul>
<li>Added TOTP validation route.</li>
<li>Added key flags: <code>allow_key</code>, <code>allow_token</code>, <code>allow_totp</code>.</li>
<li>Added user fields: <code>locale</code>, <code>timezone</code>.</li>
</ul>
<h3 id="changed-2">Changed</h3>
<ul>
<li>Renamed project <code>sso</code>, ark was taken by various products and crates.</li>
<li>Code consistency improvements.</li>
<li>Renamed audit <code>path</code> to <code>type</code> string.</li>
<li>Replaced <code>serde_urlencoded</code> with <code>serde_qs</code> for more advanced query string support.</li>
<li>Improved audit metric collection efficiency.</li>
<li>Changed authentication provider interface so callbacks always go to service.</li>
</ul>
<h2 id="section-3">0.4.0 (2019-09-09)</h2>
<h3 id="added-2">Added</h3>
<ul>
<li>Added some process metrics to Prometheus integration.</li>
<li>Created asynchronous client actor to handle outgoing HTTP requests.</li>
<li>Added environment variable <code>PASSWORD_PWNED_ENABLED</code> to enable pwned passwords integration.</li>
</ul>
<h3 id="changed-3">Changed</h3>
<ul>
<li>Replaced <code>bcrypt</code> with <code>libreauth</code> crate for password hashing.</li>
<li>Use <code>libreauth</code> key generation for CSRF keys and <code>Key</code> values.</li>
<li>Improved modules public interfaces.</li>
<li>Changed driver interface to use <code>Uuid</code> types instead of strings.</li>
<li>Renamed configuration structures to options to improve consistency.</li>
</ul>
<h3 id="fixed-2">Fixed</h3>
<ul>
<li>Fixed missing <code>dyn</code> keyword warnings.</li>
</ul>
<h2 id="section-4">0.3.0 (2019-08-03)</h2>
<h3 id="added-3">Added</h3>
<ul>
<li>Improved email templates, removed template parameters from routes.</li>
<li>Defined server routes and other constants in <code>server::api</code> module.</li>
<li>Finished synchronous and asynchronous clients.</li>
<li>Added support for audit list query cases <code>gt AND lt</code>, <code>created_gte AND created_lte</code>.</li>
<li>Added <code>/v1/metrics</code> endpoint for Prometheus integration.</li>
<li>Added support for optional audit logs to some authentication endpoints.</li>
<li>Added TLS configuration support to server and clients.</li>
<li>Added hostname configuration to server.</li>
</ul>
<h3 id="changed-4">Changed</h3>
<ul>
<li>Changed audit list query parameters when using <code>created_gte</code> or <code>created_lte</code> options, added optional <code>offset_id</code> parameter to exclude previous results.</li>
<li>Moved email handling from <code>server::smtp</code> module to <code>notify</code> module.</li>
<li>Moved <code>main.rs:Error</code> into <code>cli</code> module, refactored error handling.</li>
<li>Use <code>Forwarded</code> header instead of <code>X-Forwarded-For</code> for audit logs.</li>
<li>Renamed local authentication provider reset, update routes.</li>
<li>Improved configuration interfaces using <code>derive_builder</code> crate.</li>
</ul>
<h3 id="fixed-3">Fixed</h3>
<ul>
<li>Reset password route now returns OK in cases where user email address does not exist.</li>
<li>Fixed audit log errors were created for root key authentication when authenticating a service key.</li>
<li>Fixed internal server errors returned to client when OAuth2 provider is disabled.</li>
</ul>
<h2 id="section-5">0.2.0 (2019-07-07)</h2>
<h3 id="added-4">Added</h3>
<ul>
<li>Added audit logging to authentication routes.</li>
<li>Added is enabled flag to services, users and keys, added is revoked flag to keys.</li>
<li>Added synchronous and asynchronous clients to library.</li>
<li>Added <code>email_eq</code> query option to user list route.</li>
<li>Added local provider update user email, password routes.</li>
<li>Added type parameter to service URL callback queries.</li>
</ul>
<h3 id="changed-5">Changed</h3>
<ul>
<li>Changed database schema to use strings as IDs.</li>
<li>Changed list route endpoints to return data ID arrays.</li>
<li>Changed CSRF key, value pairs to use TTL in seconds.</li>
<li>Changed token type handling, user token split into access and refresh tokens.</li>
<li>Moved OAuth2 routes into provider groups.</li>
<li>Moved login, reset routes into local provider group.</li>
<li>Upgraded to version 3 of <code>oauth2</code> library.</li>
<li>Removed <code>skeptic</code> from tests, use Cargo test runner.</li>
<li>Moved route types to public api module.</li>
</ul>
<h3 id="fixed-4">Fixed</h3>
<ul>
<li>Fixed not validating service URLs before save using URL parse, improved URL error handling.</li>
<li>Fixed inconsistent core error display strings.</li>
<li>Fixed duplicate user email address returned internal server error code.</li>
<li>Fixed Lettre email error type handling.</li>
</ul>
<h2 id="section-6">0.1.0 (2019-05-16)</h2>
<h3 id="added-5">Added</h3>
<ul>
<li>First version.</li>
</ul>
<h1 id="developer">Developer</h1>
<h2 id="tools">Tools</h2>
<p>The <code>sso</code> crate depends on <a href="postgresql">PostgreSQL</a> and <a href="sqlite">SQLite</a> libraries.</p>
<pre class="shell"><code># Install on Ubuntu.
sudo apt install libpq-dev libsqlite3-dev libssl-dev libfuse-dev pkg-config</code></pre>
<p>Install <a href="rust">Rust</a> using <a href="rustup">rustup</a>.</p>
<p>To update the toolchain.</p>
<pre class="shell"><code>rustup self update
rustup update</code></pre>
<p>The <code>sso</code> crate depends on <a href="cargo-make">cargo make</a>, <a href="diesel">Diesel</a> and <a href="cargo-audit">cargo audit</a>, install them with Cargo.</p>
<pre class="shell"><code>cargo install --force cargo-make
cargo install --force diesel_cli --no-default-features --features &quot;postgres sqlite&quot;
cargo install --force cargo-audit</code></pre>
<p>To update crate dependencies.</p>
<pre class="shell"><code>cargo update</code></pre>
<p><a href="docker">Docker</a> and <a href="docker-compose">Docker Compose</a> are used for development, install them using the linked documentation.</p>
<p>To start containers defined in <code>docker/docker-compose.yml</code>.</p>
<pre class="shell"><code>cargo make docker-up</code></pre>
<p>To backup and restore <code>sso</code> database in <code>postgres</code> container.</p>
<pre class="shell"><code>cargo make docker-pg-dump
cargo make docker-pg-restore</code></pre>
<p>To stop and destroy containers.</p>
<pre class="shell"><code>cargo make docker-stop
cargo make docker-down</code></pre>
<h2 id="manual-1">Manual</h2>
<p>This manual is written in <a href="pandoc-markdown">Markdown</a> and converted into other formats using <a href="pandoc">Pandoc</a>.</p>
<p>To build the HTML manual.</p>
<pre class="shell"><code>cargo make manual</code></pre>
<h2 id="environment">Environment</h2>
<table>
<thead>
<tr class="header">
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>SENTRY_URL</td>
<td>Sentry URL for logging integration, optional.</td>
</tr>
<tr class="even">
<td>DATABASE_URL</td>
<td>Database connection URL, required.</td>
</tr>
<tr class="odd">
<td>DATABASE_CONNECTIONS</td>
<td>Database connections, optional.</td>
</tr>
<tr class="even">
<td>SERVER_HOSTNAME</td>
<td>Server hostname, optional.</td>
</tr>
<tr class="odd">
<td>SERVER_BIND</td>
<td>Server bind address, required.</td>
</tr>
<tr class="even">
<td>SERVER_TLS_CRT_PEM</td>
<td>Server TLS certificate files, optional.</td>
</tr>
<tr class="odd">
<td>SERVER_TLS_KEY_PEM</td>
<td></td>
</tr>
<tr class="even">
<td>SERVER_TLS_CLIENT_PEM</td>
<td>Server mutual TLS authentication, optional.</td>
</tr>
<tr class="odd">
<td>SMTP_HOST</td>
<td>SMTP server, optional.</td>
</tr>
<tr class="even">
<td>SMTP_PORT</td>
<td>…</td>
</tr>
<tr class="odd">
<td>SMTP_USER</td>
<td>…</td>
</tr>
<tr class="even">
<td>SMTP_PASSWORD</td>
<td>…</td>
</tr>
<tr class="odd">
<td>PASSWORD_PWNED_ENABLED</td>
<td>Enable <a href="pwned-passwords">Pwned Passwords</a> integration.</td>
</tr>
<tr class="even">
<td>GITHUB_CLIENT_ID</td>
<td>GitHub OAuth2 provider, optional.</td>
</tr>
<tr class="odd">
<td>GITHUB_CLIENT_SECRET</td>
<td>…</td>
</tr>
<tr class="even">
<td>MICROSOFT_CLIENT_ID</td>
<td>Microsoft OAuth2 provider, optional.</td>
</tr>
<tr class="odd">
<td>MICROSOFT_CLIENT_SECRET</td>
<td>…</td>
</tr>
</tbody>
</table>
<h3 id="ubuntu">Ubuntu</h3>
<p>Write <code>export $NAME=&quot;$VALUE&quot;</code> statements to file <code>.env</code> and run <code>source .env</code> to export variables in open terminal. See <code>sso/.env</code> for example.</p>
<h2 id="database">Database</h2>
<p>To reset and create new <a href="postgresql">PostgreSQL</a> database migrations for <a href="diesel">Diesel</a>. These commands assume docker container is running.</p>
<pre class="shell"><code>cargo make postgres-reset
cargo make postgres-migration $migration_name</code></pre>
<p>To reset and create new <a href="sqlite">SQLite</a> database migrations for <a href="diesel">Diesel</a>.</p>
<pre class="shell"><code>cargo make sqlite-reset
cargo make sqlite-migration $migration_name</code></pre>
<h2 id="build">Build</h2>
<p>To build libraries and binaries.</p>
<pre class="shell"><code>cargo make build
cargo make release
cargo make release-flow
cargo make install</code></pre>
<p>To lint source code using <a href="clippy">clippy</a>.</p>
<pre class="shell"><code>cargo make clippy</code></pre>
<p>To build and open documentation.</p>
<pre class="shell"><code>cargo make doc</code></pre>
<p>To build docker image.</p>
<pre class="shell"><code>cargo make docker-build</code></pre>
<p>To audit crate dependencies.</p>
<pre class="shell"><code>cargo make audit</code></pre>
<p><a href="cargo-publishing">To publish crate(s)</a>.</p>
<h2 id="test">Test</h2>
<p>To run unit tests.</p>
<pre class="shell"><code>cargo make test</code></pre>
<p>For integration tests, the following environment variables are required. A server hosting the API to be tested must be available at <code>SERVER_URL</code> address.</p>
<table>
<thead>
<tr class="header">
<th>Variable</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>TEST_SSO_URL</td>
<td>Server URL.</td>
</tr>
<tr class="even">
<td>TEST_SSO_KEY</td>
<td>Root key value.</td>
</tr>
</tbody>
</table>
<p>To run integration tests.</p>
<pre class="shell"><code>cargo make test-integration</code></pre>
</body>
</html>
